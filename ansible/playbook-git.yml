---
- name: DÃ©ploiement Rapide avec Git Clone
  hosts: all
  become: yes
  vars:
    app_directory: /home/{{ ansible_user }}/stayava-hotel
    repo_url: "https://github.com/Quentin693/CI-CDproject.git"
    
  tasks:
    # 1. Installer les outils nÃ©cessaires
    - name: ğŸ“¦ Installer git et curl
      apt:
        name:
          - git
          - curl
        state: present
        update_cache: yes
    
    # 2. Installer Node.js via NodeSource
    - name: ğŸ”§ TÃ©lÃ©charger le script d'installation Node.js
      shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
    
    - name: ğŸ“¦ Installer Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes
    
    # 3. Supprimer l'ancien rÃ©pertoire si existe
    - name: ğŸ§¹ Nettoyer l'ancien dÃ©ploiement
      file:
        path: "{{ app_directory }}"
        state: absent
      become_user: "{{ ansible_user }}"
    
    # 4. Cloner le repo depuis GitHub (RAPIDE!)
    - name: ğŸ“¥ Cloner le repository depuis GitHub
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
        force: yes
      become_user: "{{ ansible_user }}"
    
    # 5. Installer les dÃ©pendances
    - name: ğŸ“¦ Installation des dÃ©pendances
      command: npm install
      args:
        chdir: "{{ app_directory }}"
      become_user: "{{ ansible_user }}"
    
    # 6. Build
    - name: ğŸ—ï¸ Build de l'application
      command: npm run build
      args:
        chdir: "{{ app_directory }}"
      environment:
        NEXT_TELEMETRY_DISABLED: "1"
      become_user: "{{ ansible_user }}"
    
    # 7. ArrÃªter les anciens processus
    - name: ğŸ›‘ ArrÃªter les anciens processus
      shell: |
        pkill -f "npm.*start" || true
        pkill -f "node.*next.*start" || true
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
    
    # 8. DÃ©marrer l'app
    - name: ğŸš€ DÃ©marrer l'application
      shell: |
        cd {{ app_directory }}
        nohup npm start > /tmp/stayava.log 2>&1 &
        sleep 10
      become_user: "{{ ansible_user }}"
    
    # 9. Afficher les logs pour debug
    - name: ğŸ“‹ Afficher les derniÃ¨res lignes des logs
      command: tail -20 /tmp/stayava.log
      become_user: "{{ ansible_user }}"
      register: app_logs
      ignore_errors: yes
    
    - name: ğŸ“„ Logs de l'application
      debug:
        msg: "{{ app_logs.stdout_lines }}"
      when: app_logs.stdout_lines is defined
    
    # 10. VÃ©rifier que le processus tourne
    - name: ğŸ” VÃ©rifier que npm start tourne
      shell: ps aux | grep "npm.*start" | grep -v grep
      become_user: "{{ ansible_user }}"
      register: process_check
      ignore_errors: yes
    
    - name: âœ… Processus en cours
      debug:
        msg: "{{ process_check.stdout_lines }}"
    
    - name: ğŸ‰ DÃ©ploiement terminÃ© !
      debug:
        msg: 
          - "ğŸ‰ DÃ©ploiement terminÃ© !"
          - "ğŸ“‚ Application dans : {{ app_directory }}"
          - "ğŸŒ AccÃ¨s (si le port 3000 est ouvert) : http://{{ ansible_host }}:3000"
          - "ğŸ“‹ Logs : tail -f /tmp/stayava.log"

