name: üê≥ CD Docker - Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de d√©ploiement'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - develop

jobs:
  deploy-docker:
    name: üöÄ D√©ploiement Docker
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: http://${{ secrets.GCP_HOST }}
    
    steps:
      # 1. Checkout du code
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      # 2. Configuration SSH
      - name: üîê Configuration SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
      
      # 3. Ajouter le host aux known_hosts
      - name: üìù Ajouter le host SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts
      
      # 4. Tester la connexion SSH
      - name: üîó Test connexion SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} "echo 'Connexion SSH r√©ussie'"
      
      # 5. Installer Docker sur le serveur distant (si n√©cessaire)
      - name: üê≥ Installer Docker sur le serveur
        run: |
          ssh ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'EOF'
            # V√©rifier si Docker est install√©
            if ! command -v docker &> /dev/null; then
              echo "Installation de Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              rm get-docker.sh
            fi
            
            # V√©rifier si Docker Compose est install√©
            if ! command -v docker-compose &> /dev/null; then
              echo "Installation de Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            echo "Docker version:"
            docker --version
            echo "Docker Compose version:"
            docker-compose --version
          EOF
      
      # 6. Copier les fichiers n√©cessaires sur le serveur
      - name: üì§ Copier les fichiers sur le serveur
        run: |
          ssh ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} "mkdir -p ~/stayava-hotel-docker"
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude 'coverage' \
            --exclude '__tests__' \
            ./ ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }}:~/stayava-hotel-docker/
      
      # 7. Build et d√©marrage des conteneurs Docker
      - name: üèóÔ∏è Build et d√©marrage Docker
        run: |
          ssh ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'EOF'
            cd ~/stayava-hotel-docker
            
            # Arr√™ter et supprimer les anciens conteneurs
            docker-compose down || true
            
            # Build l'image
            docker-compose build --no-cache
            
            # D√©marrer les conteneurs
            docker-compose up -d
            
            # Afficher les logs
            echo "Conteneurs en cours d'ex√©cution:"
            docker-compose ps
          EOF
      
      # 8. V√©rifier que l'application r√©pond
      - name: ‚úÖ V√©rifier le d√©ploiement
        run: |
          ssh ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'EOF'
            echo "Attente du d√©marrage de l'application..."
            sleep 15
            
            # V√©rifier que le conteneur tourne
            if docker ps | grep -q "stayava-hotel-app"; then
              echo "‚úÖ Le conteneur est en cours d'ex√©cution"
            else
              echo "‚ùå Le conteneur ne tourne pas"
              docker-compose logs
              exit 1
            fi
            
            # Tester l'endpoint
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ L'application r√©pond correctement"
            else
              echo "‚ùå L'application ne r√©pond pas"
              docker-compose logs
              exit 1
            fi
          EOF
      
      # 9. Afficher les logs
      - name: üìã Afficher les logs
        if: always()
        run: |
          ssh ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'EOF'
            cd ~/stayava-hotel-docker
            echo "=== Logs de l'application ==="
            docker-compose logs --tail=50 app
          EOF
      
      # 10. Notification de succ√®s
      - name: üéâ D√©ploiement Docker r√©ussi
        run: |
          echo "‚úÖ D√©ploiement Docker termin√© avec succ√®s !"
          echo "üåê Application accessible sur: http://${{ secrets.GCP_HOST }}"

